<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fixed OBS Flip Timer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap');

        :root {
            --text-color: #ffffff;
            --font-size: 110px;
            --digit-width: 0.7em;
            --digit-height: 1.1em; /* Tightened height */
            --accent: #00ffcc;
            --bar-bg: rgba(15, 15, 15, 0.98);
        }

        body, html {
            background-color: transparent;
            margin: 0; padding: 0;
            height: 100%; overflow: hidden;
            font-family: 'Roboto Mono', monospace;
            color: var(--text-color);
        }

        .wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .timer-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #clock {
            display: flex;
            align-items: center;
            font-size: var(--font-size);
            font-weight: 700;
            text-shadow: 0px 10px 30px rgba(0,0,0,0.8);
        }

        /* Essential: Fixed height and width with hidden overflow prevent stacking */
        .digit-box {
            position: relative;
            width: var(--digit-width);
            height: var(--digit-height);
            overflow: hidden; 
            text-align: center;
        }

        .digit {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            white-space: nowrap; 
            /* Ensure digits don't have extra padding */
            line-height: 1; 
        }

        .separator {
            width: 0.4em;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 0.1em;
        }

        /* --- CONTROL BAR --- */
        .control-bar {
            background: var(--bar-bg);
            height: 120px;
            border-top: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-evenly;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .group { display: flex; align-items: center; gap: 10px; }
        .input-item { display: flex; flex-direction: column; align-items: center; color: #888; font-size: 10px; }

        input {
            width: 55px; height: 35px; background: #000; border: 1px solid #444;
            color: var(--accent); text-align: center; font-size: 20px; border-radius: 4px;
        }

        button {
            padding: 10px 18px; font-family: inherit; font-weight: bold; cursor: pointer;
            background: #2a2a2a; color: white; border: 1px solid #444; border-radius: 4px;
        }

        button.active { background: var(--accent); color: #000; }
        #startBtn { min-width: 100px; border-bottom: 3px solid var(--accent); }
        #setBtn { background: #ffcc00; color: #000; border: none; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="timer-area">
        <div id="clock">
            <div class="digit-box" id="d0"><div class="digit">0</div></div>
            <div class="digit-box" id="d1"><div class="digit">0</div></div>
            <div class="separator">:</div>
            <div class="digit-box" id="d2"><div class="digit">0</div></div>
            <div class="digit-box" id="d3"><div class="digit">0</div></div>
            <div class="separator">:</div>
            <div class="digit-box" id="d4"><div class="digit">0</div></div>
            <div class="digit-box" id="d5"><div class="digit">0</div></div>
        </div>
    </div>

    <div class="control-bar">
        <div class="group">
            <button id="modeUp" class="active">Count Up</button>
            <button id="modeDown">Timer</button>
        </div>

        <div class="group" id="settings-group" style="visibility: hidden;">
            <div class="input-item"><label>H</label><input type="number" id="h" value="0"></div>
            <div class="input-item"><label>M</label><input type="number" id="m" value="5"></div>
            <div class="input-item"><label>S</label><input type="number" id="s" value="0"></div>
            <button id="setBtn">SET</button>
        </div>

        <div class="group">
            <button id="startBtn">Start</button>
            <button id="resetBtn">Reset</button>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        pulseLastNSeconds: 10,
        pulseColor: "#ff3366",
        normalColor: "#ffffff",
        animSpeed: 400
    };

    let isRunning = false, isCountdown = false;
    let startTime = 0, elapsedTime = 0, customDuration = 0;
    let timerInterval = null;
    let lastTimeStr = "000000";

    const clock = document.getElementById('clock');
    const startBtn = document.getElementById('startBtn');
    const settingsGroup = document.getElementById('settings-group');

    function forceCleanBox(boxId, value) {
        const box = document.getElementById(boxId);
        anime.remove(box.querySelectorAll('.digit')); 
        box.innerHTML = `<div class="digit" style="transform:translateY(0); opacity:1;">${value}</div>`;
    }

    function animateDigit(boxId, newValue) {
        const box = document.getElementById(boxId);
        const oldDigits = box.querySelectorAll('.digit');
        
        // 1. Create the new digit and place it above the view
        const newDigit = document.createElement('div');
        newDigit.className = 'digit';
        newDigit.innerText = newValue;
        newDigit.style.opacity = "0";
        newDigit.style.transform = "translateY(-100%)";
        box.appendChild(newDigit);

        // 2. Animate OLD digits down and out
        anime({
            targets: oldDigits,
            translateY: '100%',
            opacity: 0,
            duration: CONFIG.animSpeed,
            easing: 'easeInOutQuart',
            complete: () => {
                oldDigits.forEach(el => { if(el.parentNode === box) box.removeChild(el); });
            }
        });

        // 3. Animate NEW digit into center
        anime({
            targets: newDigit,
            translateY: '0%',
            opacity: 1,
            duration: CONFIG.animSpeed,
            easing: 'easeInOutQuart'
        });
    }

    function updateDisplay(ms, instant = false) {
        if (ms < 0) ms = 0;
        let totalSecs = Math.floor(ms / 1000);
        let h = Math.floor(totalSecs / 3600);
        let m = Math.floor((totalSecs % 3600) / 60);
        let s = totalSecs % 60;

        let timeStr = h.toString().padStart(2, '0') + m.toString().padStart(2, '0') + s.toString().padStart(2, '0');

        if (isRunning && isCountdown && totalSecs <= CONFIG.pulseLastNSeconds && totalSecs > 0) {
            if (timeStr !== lastTimeStr) {
                clock.style.color = CONFIG.pulseColor;
                anime({ targets: '#clock', scale: [1, 1.1, 1], duration: 300 });
            }
        } else {
            clock.style.color = CONFIG.normalColor;
        }

        for (let i = 0; i < 6; i++) {
            if (timeStr[i] !== lastTimeStr[i]) {
                if (instant) {
                    forceCleanBox(`d${i}`, timeStr[i]);
                } else {
                    animateDigit(`d${i}`, timeStr[i]);
                }
            }
        }
        lastTimeStr = timeStr;
    }

    function update() {
        const now = Date.now();
        let diff = isCountdown ? customDuration - (now - startTime + elapsedTime) : now - startTime + elapsedTime;

        if (isCountdown && diff <= 0) {
            diff = 0;
            stop();
            anime({ targets: '#clock', scale: [1, 1.3], color: '#ff0000', duration: 800, direction: 'alternate', loop: 2 });
        }
        updateDisplay(diff);
    }

    function applyInputs() {
        stop();
        elapsedTime = 0;
        const hh = parseInt(document.getElementById('h').value) || 0;
        const mm = parseInt(document.getElementById('m').value) || 0;
        const ss = parseInt(document.getElementById('s').value) || 0;
        customDuration = (hh * 3600 + mm * 60 + ss) * 1000;
        lastTimeStr = "XXXXXX"; 
        updateDisplay(customDuration, true); 
    }

    function start() {
        if (isRunning) return;
        if (isCountdown && elapsedTime === 0) applyInputs();
        isRunning = true;
        startTime = Date.now();
        timerInterval = setInterval(update, 100);
        startBtn.innerText = "Pause";
    }

    function stop() {
        if (!isRunning) return;
        isRunning = false;
        elapsedTime += Date.now() - startTime;
        clearInterval(timerInterval);
        startBtn.innerText = "Start";
    }

    function reset() {
        stop();
        elapsedTime = 0;
        lastTimeStr = "XXXXXX";
        isCountdown ? applyInputs() : updateDisplay(0, true);
        clock.style.color = CONFIG.normalColor;
    }

    document.getElementById('setBtn').onclick = applyInputs;
    document.getElementById('modeUp').onclick = function() {
        isCountdown = false; this.classList.add('active');
        document.getElementById('modeDown').classList.remove('active');
        settingsGroup.style.visibility = 'hidden'; reset();
    };
    document.getElementById('modeDown').onclick = function() {
        isCountdown = true; this.classList.add('active');
        document.getElementById('modeUp').classList.remove('active');
        settingsGroup.style.visibility = 'visible'; reset();
    };
    startBtn.onclick = () => isRunning ? stop() : start();
    document.getElementById('resetBtn').onclick = reset;

    document.addEventListener('keydown', (e) => {
        if (e.code === "Space") { e.preventDefault(); startBtn.click(); }
        if (e.code === "KeyR") reset();
    });
</script>
</body>
</html>